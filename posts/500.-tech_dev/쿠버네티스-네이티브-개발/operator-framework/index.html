<!doctype html><html lang=en><head><title>k8s operator 패턴 구현 (Operator Framework)</title><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><link rel=stylesheet href=/application.a645a51ce96fb50237bbc1963357f13368de2c1e10aa221b68ef773965e2a474.css integrity="sha256-pkWlHOlvtQI3u8GWM1fxM2jeLB4QqiIbaO93OWXipHQ="><meta property="og:title" content="양성연의 블로그"><meta property="og:type" content="website"><meta property="og:description" content><meta property="og:image" content="/images/default-avatar.jpeg"><meta property="og:url" content="https://kubesy.com/"><meta name=description content="Operator Framework"><script integrity="sha256-DO4ugzEwhTW1Id1UIWn0gUJWaebCYOypeTit6LW4QB4=">let theme=localStorage.getItem("theme-scheme")||localStorage.getItem("darkmode:color-scheme")||"light";theme==="system"&&(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?theme="dark":theme="light"),document.documentElement.setAttribute("data-theme",theme)</script></head><body class="type-posts kind-page" data-bs-spy=scroll data-bs-target=#TableOfContents data-bs-offset=80><div class="container-fluid bg-secondary wrapper"><nav class="navbar navbar-expand-xl top-navbar shadow" id=top-navbar><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button>
<i data-feather=sidebar></i>
</button>
<a class=navbar-brand href=/>양성연의 블로그</a>
<button class="navbar-toggler navbar-light" id=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#top-nav-items aria-label=menu>
<i data-feather=menu></i></button><div class="collapse navbar-collapse dynamic-navbar" id=top-nav-items><ul class="nav navbar-nav ms-auto"><li class=nav-item><a class=nav-link href=/#home>Home</a></li><li class=nav-item><a class=nav-link href=/#about>About</a></li><li class=nav-item><a class=nav-link href=/#skills>Skills</a></li><li class=nav-item><a class=nav-link href=/#education>Education</a></li><li class=nav-item><a class=nav-link href=/#experiences>Experiences</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>More</a><div class=dropdown-menu aria-labelledby=navbarDropdown><a class=dropdown-item href=/#recent-posts>Recent Posts</a></div></li><div id=top-navbar-divider></div><li class=nav-item><a class=nav-link id=blog-link href=/posts>Posts</a></li></ul></div></div></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/search><input type=text name=keyword placeholder=Search data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/posts/ data-filter=all>Posts</a></li><div class=subtree><li><a class=list-link href=/posts/100.-diary/ title="100. Diary">100. Diary</a></li><li><a class=list-link href=/posts/200.-novel/ title="200. Novel">200. Novel</a></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/300.-study/> 300. Study</a><ul><li><i data-feather=plus-circle></i><a class=list-link href=/posts/300.-study/301.-kubernetes-deep-dive/> 301. Kubernetes deep-dive!</a><ul><li><a class=list-link href=/posts/300.-study/301.-kubernetes-deep-dive/hello-k8s-dev-world/ title="1. Hello, k8s Dev World!">1. Hello, k8s Dev World!</a></li></ul></li><li><a class=list-link href=/posts/300.-study/302.-openstack-deep-dive/ title="302. OpenStack deep-dive!">302. OpenStack deep-dive!</a></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/300.-study/303.-java-spring-boot-/> 303. Java Spring Boot</a><ul><li><a class=list-link href=/posts/300.-study/303.-java-spring-boot-/1.-%EA%B0%9C%EB%85%90-%EB%B0%8F-%ED%99%98%EA%B2%BD-%EA%B5%AC%EC%B6%95-%EA%B7%B8%EB%A6%AC%EA%B3%A0-%EA%B0%84%EB%8B%A8%ED%95%9C-%EA%B5%AC%EB%8F%99/ title="1. 개념 및 환경 구축 그리고 간단한 구동">1. 개념 및 환경 구축 그리고 간단한 구동</a></li></ul></li></ul></li><li><a class=list-link href=/posts/400.-project/ title="400. Project">400. Project</a></li><li><i data-feather=minus-circle></i><a class="active list-link" href=/posts/500.-tech_dev/> 500. Tech & Dev</a><ul class=active><li><i data-feather=minus-circle></i><a class="active list-link" href=/posts/500.-tech_dev/%EC%BF%A0%EB%B2%84%EB%84%A4%ED%8B%B0%EC%8A%A4-%EB%84%A4%EC%9D%B4%ED%8B%B0%EB%B8%8C-%EA%B0%9C%EB%B0%9C/> K8s Native Development</a><ul class=active><li><a class="active list-link" href=/posts/500.-tech_dev/%EC%BF%A0%EB%B2%84%EB%84%A4%ED%8B%B0%EC%8A%A4-%EB%84%A4%EC%9D%B4%ED%8B%B0%EB%B8%8C-%EA%B0%9C%EB%B0%9C/operator-framework/ title="k8s operator 패턴 구현 (Operator Framework)">k8s operator 패턴 구현 (Operator Framework)</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/500.-tech_dev/%EC%BF%A0%EB%B2%84%EB%84%A4%ED%8B%B0%EC%8A%A4-%EA%B8%B0%EB%B3%B8/> 쿠버네티스가 뭐지</a><ul><li><a class=list-link href=/posts/500.-tech_dev/%EC%BF%A0%EB%B2%84%EB%84%A4%ED%8B%B0%EC%8A%A4-%EA%B8%B0%EB%B3%B8/%EC%BF%A0%EB%B2%84%EB%84%A4%ED%8B%B0%EC%8A%A4%EA%B0%80-%EB%AD%90%EC%A7%80/ title="쿠버네티스가 뭐지 1">쿠버네티스가 뭐지 1</a></li><li><a class=list-link href=/posts/500.-tech_dev/%EC%BF%A0%EB%B2%84%EB%84%A4%ED%8B%B0%EC%8A%A4-%EA%B8%B0%EB%B3%B8/%EC%BF%A0%EB%B2%84%EB%84%A4%ED%8B%B0%EC%8A%A4%EA%B0%80-%EB%AD%90%EC%A7%802/ title="쿠버네티스가 뭐지 2">쿠버네티스가 뭐지 2</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/500.-tech_dev/%EC%BF%A0%EB%B2%84%EB%84%A4%ED%8B%B0%EC%8A%A4-cncf-landscape/> K8s CNCF Landscape</a><ul><li><a class=list-link href=/posts/500.-tech_dev/%EC%BF%A0%EB%B2%84%EB%84%A4%ED%8B%B0%EC%8A%A4-cncf-landscape/1_harbor/ title=Harbor>Harbor</a></li></ul></li><li><a class=list-link href=/posts/500.-tech_dev/kolla-ansible/ title=Kolla-Ansible>Kolla-Ansible</a></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/500.-tech_dev/%EA%B8%B0%ED%83%80/> etc</a><ul><li><a class=list-link href=/posts/500.-tech_dev/%EA%B8%B0%ED%83%80/%EA%B8%B0%EC%88%A0-%EB%B8%94%EB%A1%9C%EA%B7%B8-%EC%9C%A0%EC%A7%80%EB%B3%B4%EC%88%98/ title="방치해두었던 hugo 블로그 최신화 경험">방치해두었던 hugo 블로그 최신화 경험</a></li></ul></li></ul></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(/images/default-hero.jpg)></div><div class=page-content><div class="author-profile ms-auto align-self-lg-center"><img class=rounded-circle src=/images/default-avatar_hu_403664f4887f3130.jpeg alt="Author Image"><h5 class=author-name>Seong-Yeon Yang</h5><p class=text-muted>Sunday, November 10, 2024</p></div><div class=title><h1>k8s operator 패턴 구현 (Operator Framework)</h1></div><div class=post-content id=post-content><h2 id=개요->개요 :</h2><p><a href=https://operatorframework.io/ target=_blank rel=noopener>https://operatorframework.io/</a></p><p>Red Hat이 주도하는 오픈소스 프로젝트로, 오퍼레이터 개발을 단순화하고 자동화하기 위한 다양한 도구와 라이브러리를 제공합니다. Operator SDK는 Kubebuilder 기반으로 만들어졌지만, Helm, Ansible 등 다양한 언어와 프레임워크를 지원합니다.
또한 레드햇이 주도하여 개발 중으로 보이는 openstack operator 프로젝트에 사용되었습니다.</p><p>쿠버네티스의 오퍼레이터와 오퍼레이터 패턴은 공식 문서 <a href=https://kubernetes.io/ko/docs/concepts/extend-kubernetes/operator/ target=_blank rel=noopener>https://kubernetes.io/ko/docs/concepts/extend-kubernetes/operator/</a>에 정리되어 있습니다.</p><blockquote><p>오퍼레이터(Operator)는 사용자 정의 리소스를 사용하여 애플리케이션 및 해당 컴포넌트를 관리하는 쿠버네티스의 소프트웨어 익스텐션이다. 오퍼레이터는 쿠버네티스 원칙, 특히 컨트롤 루프를 따른다.</p></blockquote><p>쿠버네티스 코드 자체를 수정하지 않고 기능을 확대한다는 점에서 큰 이점을 가지고 있습니다. 이미 cncf 의 많은 프로젝트들이 해당 기법을 사용하여 기능을 제공하고 있습니다. CKA 시험에서도 24년 11월 25일 이후부터 시험항목에 관련 내용이 추가됩니다.</p><p>Operator Framework 는 크게 세 가지 특성 Operator SDK(build, test, iterate), Operator Lifecycle manager(install, manage, update), <a href=http://operatorhub.io/ target=_blank rel=noopener>Operatorhub.io</a> (Publish & share) 을 제공 합니다.</p><p>이번 글에서는 코드 수준의 오퍼레이터 코드 작성 및 빌드 방식에 집중합니다.</p><h3 id=kubebuilder-구조>kubebuilder 구조</h3><p>operator framework 가 내포한 kubebuilder는 아래와 같은 구조를 가지고 있습니다.</p><p>kubebuilder 는 <a href=https://github.com/kubernetes-sigs/controller-runtime target=_blank rel=noopener>controller-runtime</a> 이 핵심 라이브러리 입니다. [ https://github.com/kubernetes/sample-controller/blob/master/controller.go 이런 예시 프로젝트가 <a href=https://github.com/kubernetes/code-generator target=_blank rel=noopener>code-generator</a> 기반 인 것과 비교할 수 있습니다. ]</p><img src=/posts/images/k8s_native/operator.png class=center><p>이미지에서 controller-runtime의 각 구성 요소(Client, Cache, Controller, Predicate, Reconciler, Webhook)에 대한 설명을 아래에 정리했습니다:</p><h4 id=1-client><strong>1. Client</strong></h4><p><strong>위치</strong>: sigs.k8s.io/controller-runtime/pkg/client</p><p><strong>역할</strong>:</p><ul><li>Kubernetes API 서버와 통신하는 인터페이스로, API 요청을 전송합니다.</li><li>리소스를 조회(Create, Get, List), 수정(Update, Patch), 삭제(Delete)할 수 있는 메서드를 제공합니다.</li><li>캐시된 데이터를 조회할 수도 있으며, 필요한 경우 API 서버로 직접 요청을 보냅니다.</li></ul><p><strong>특징</strong>:</p><ul><li>캐시된 데이터를 먼저 조회하여 성능을 최적화합니다.</li><li>인증 및 프로토콜 처리를 자동으로 수행합니다.</li></ul><h4 id=2-cache><strong>2. Cache</strong></h4><p><strong>위치</strong>: sigs.k8s.io/controller-runtime/pkg/cache</p><p><strong>역할</strong>:</p><ul><li>최근 Watch 또는 GET 요청에서 조회된 리소스를 저장하는 메모리 내 캐시입니다.</li><li>Informer를 사용하여 Kubernetes 리소스를 캐싱하고, 변경 사항을 지속적으로 업데이트합니다.</li></ul><p><strong>특징</strong>:</p><ul><li>Controller와 Webhook에서 공통적으로 사용됩니다.</li><li>캐시를 통해 API 서버와의 통신 횟수를 줄이고, 성능을 높입니다.</li></ul><h4 id=3-controller><strong>3. Controller</strong></h4><p><strong>위치</strong>: sigs.k8s.io/controller-runtime/pkg/controller</p><p><strong>역할</strong>:</p><ul><li>리소스의 변경 사항을 감지하고, 이를 Reconciler에 전달하여 리소스 상태를 관리합니다.</li><li>각 CRD(Custom Resource Definition)마다 하나의 Controller가 생성됩니다.</li></ul><p><strong>특징</strong>:</p><ul><li>이벤트 필터링(Filtering)을 통해 필요한 이벤트만 처리할 수 있습니다.</li><li>큐(Queue)를 사용하여 백오프(Backoff) 및 재시도(Re-queuing)를 관리합니다.</li><li>Reconciler를 호출하여 상태를 조정하는 로직을 실행합니다.</li></ul><h4 id=4-predicate><strong>4. Predicate</strong></h4><p><strong>위치</strong>: sigs.k8s.io/controller-runtime/pkg/predicate</p><p><strong>역할</strong>:</p><ul><li>이벤트를 필터링하여 Reconciler에 전달할 필요가 있는지 여부를 결정합니다.</li></ul><p><strong>특징</strong>:</p><ul><li>Create, Update, Delete, Generic 이벤트에 대해 필터링 로직을 구현할 수 있습니다.</li><li>예를 들어, 특정 레이블이 있는 리소스의 변경 사항만 처리하거나, 특정 필드 값의 변경만 감지할 수 있습니다.</li></ul><h4 id=5-reconciler><strong>5. Reconciler</strong></h4><p><strong>위치</strong>: sigs.k8s.io/controller-runtime/pkg/reconcile</p><p><strong>역할</strong>:</p><ul><li>리소스의 현재 상태와 원하는 상태를 비교하고, 이를 동기화하는 로직을 구현합니다.</li><li>사용자 정의 Reconciler는 Reconcile 메서드를 구현해야 합니다.</li></ul><p><strong>특징</strong>:</p><ul><li>Reconcile 메서드는 이벤트가 발생할 때마다 호출되며, 리소스를 업데이트하거나 다른 API 요청을 전송할 수 있습니다.</li><li>주로 idempotent(멱등성)을 유지하도록 설계되어야 합니다.</li><li>Reconcile 메서드의 반환 값은 reconcile.Result로, 재시도 여부와 간격을 결정할 수 있습니다.</li></ul><h4 id=6-webhook><strong>6. Webhook</strong></h4><p><strong>위치</strong>: sigs.k8s.io/controller-runtime/pkg/webhook</p><p><strong>역할</strong>:</p><p>리소스의 Admission Request(생성, 업데이트 요청)를 가로채어 검증 및 수정 작업을 수행합니다.</p><p><strong>종류</strong>:</p><ul><li>Defaulter: 리소스의 기본값을 설정합니다. 필드 값이 비어 있을 경우 기본값을 채워 넣습니다.</li><li>Validator: 리소스의 유효성을 검사합니다. 잘못된 형식이나 비정상적인 값이 있는 경우 요청을 거부합니다.</li></ul><p><strong>특징</strong>:</p><ul><li>Kubernetes API 서버와의 통신을 통해 AdmissionRequest를 처리합니다.</li><li>사용자 정의 Webhook을 통해 리소스 검증 및 수정 로직을 추가할 수 있습니다.</li></ul><h2 id=문서-따라하기>문서 따라하기</h2><p><a href=https://sdk.operatorframework.io/docs/building-operators/golang/tutorial/ target=_blank rel=noopener>https://sdk.operatorframework.io/docs/building-operators/golang/tutorial/</a> 문서를 따라 합니다.</p><h4 id=overview>overview</h4><ul><li>다음 프로젝트를 수행합니다.<ul><li>Memcached 디플로이먼트가 존재하지 않는다면, 생성합니다.</li><li>커스텀 리소스 스펙에 정의된 isk 크기와 동일한 상황에 있는 것을 보장합니다.</li><li>Memcached CR의 상태를 Status Writer를 통해 해당 CR의 파드 이름을 사용하여 업데이트 합니다.</li></ul></li></ul><h4 id=설치>설치</h4><pre><code>**Compile and install from master**

```bash
git clone https://github.com/operator-framework/operator-sdk
cd operator-sdk
git checkout master
make install
```
</code></pre><h4 id=프로젝트-생성>프로젝트 생성</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir memcached-operator
</span></span><span style=display:flex><span>cd memcached-operator
</span></span><span style=display:flex><span>operator-sdk init --domain example.com --repo github.com/example/memcached-operator
</span></span></code></pre></div><p><strong>환경 확인</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~/memcached-operator $ ls
</span></span><span style=display:flex><span>cmd  config  Dockerfile  go.mod  go.sum  hack  Makefile  PROJECT  README.md  test 
</span></span></code></pre></div><p><code>--domain</code> 은 API group의 prefix가 됩니다. k8s에서의 대표적 그룹 예시는 <code>apps</code> 나 <code>rbac.authoriztion.k8s.io</code> 가 있습니다. 좀 더 <strong>구체적인 내용</strong>(쿠버네티스의 api를 이해하는 데 도움이 됩니다)은 <a href=https://book.kubebuilder.io/cronjob-tutorial/gvks.html target=_blank rel=noopener>https://book.kubebuilder.io/cronjob-tutorial/gvks.html</a> 에서 확인할 수 있습니다. 또한 생성된 프로젝트의 기본 구조는 <a href=https://book.kubebuilder.io/cronjob-tutorial/basic-project.html target=_blank rel=noopener>https://book.kubebuilder.io/cronjob-tutorial/basic-project.html</a> 문서를 확인하면 좋습니다.</p><ul><li>go.mod</li><li>Makefile : 프로젝트 작업에 필요한 여러 명령어들이 정리되어 있습니다. 해당 파일을 분석하면 어떤 작업을 할 수 있는지 대략적으로 감을 잡을 수 있습니다.</li><li>PROJECT : Kubebuilder 가 사용할 메타데이터 입니다. 새로운 구성요소를 scaffolding (리소스를 빠르게 <strong>초기화하고 설정할 수 있는 템플릿이나 자동화된 생성 도구</strong>를 의미) 하는 데 필요 합니다.</li></ul><p>config 폴더 아래에는 <a href=https://sigs.k8s.io/kustomize target=_blank rel=noopener>Kustomize</a> YAML 정의들을 가지고 있고, 추후에 컨트롤러를 작성하기 시작하면, 커스텀 리소스 정의나 RBAC 설정 그리고 웹훅 설정 등도 생성되게 됩니다.</p><p>참고로 <code>--repo=&lt;path></code> 설정은 <code>$GOPATH/src</code> 밖에서 프로젝트를 생성할 때 사용 되어야 합니다.</p><h5 id=manager><strong>Manager</strong></h5><p>cmd/main.go 는 오퍼레이터의 메인 프로그램이고 <a href=https://pkg.go.dev/sigs.k8s.io/controller-runtime/pkg/manager#Manager target=_blank rel=noopener>Manager</a>를 초기화하고 구동 시킵니다.</p><p>매니저는 네임스페이스의 제한 둘 수 있습니다. 해당 네임스페이스에서만 모든 컨트롤러는 리소스를 watch 할 수 있습니다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>mgr</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ctrl</span>.<span style=color:#a6e22e>NewManager</span>(<span style=color:#a6e22e>cfg</span>, <span style=color:#a6e22e>manager</span>.<span style=color:#a6e22e>Options</span>{<span style=color:#a6e22e>Namespace</span>: <span style=color:#a6e22e>namespace</span>})
</span></span></code></pre></div><p>만약 모든 네임스페이스를 가능하게 하려면, 빈 값으로 두면 됩니다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>mgr</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ctrl</span>.<span style=color:#a6e22e>NewManager</span>(<span style=color:#a6e22e>cfg</span>, <span style=color:#a6e22e>manager</span>.<span style=color:#a6e22e>Options</span>{<span style=color:#a6e22e>Namespace</span>: <span style=color:#e6db74>&#34;&#34;</span>})
</span></span></code></pre></div><p>Operator scope에 대한 더 심도있는 내용은 <a href=https://sdk.operatorframework.io/docs/building-operators/golang/operator-scope/ target=_blank rel=noopener>https://sdk.operatorframework.io/docs/building-operators/golang/operator-scope/</a> 문서를 살펴보아야 합니다.</p><ul><li><p><strong>Create a new API and Controller</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~/memcached-operator $ operator-sdk create api --group cache --version v1alpha1 --kind Memcached --resource --controller
</span></span><span style=display:flex><span>INFO<span style=color:#f92672>[</span>0000<span style=color:#f92672>]</span> Writing kustomize manifests <span style=color:#66d9ef>for</span> you to edit... 
</span></span><span style=display:flex><span>INFO<span style=color:#f92672>[</span>0000<span style=color:#f92672>]</span> Writing scaffold <span style=color:#66d9ef>for</span> you to edit...          
</span></span><span style=display:flex><span>INFO<span style=color:#f92672>[</span>0000<span style=color:#f92672>]</span> api/v1alpha1/memcached_types.go              
</span></span><span style=display:flex><span>INFO<span style=color:#f92672>[</span>0000<span style=color:#f92672>]</span> api/v1alpha1/groupversion_info.go            
</span></span><span style=display:flex><span>INFO<span style=color:#f92672>[</span>0000<span style=color:#f92672>]</span> internal/controller/suite_test.go            
</span></span><span style=display:flex><span>INFO<span style=color:#f92672>[</span>0000<span style=color:#f92672>]</span> internal/controller/memcached_controller.go  
</span></span><span style=display:flex><span>INFO<span style=color:#f92672>[</span>0000<span style=color:#f92672>]</span> internal/controller/memcached_controller_test.go 
</span></span><span style=display:flex><span>INFO<span style=color:#f92672>[</span>0000<span style=color:#f92672>]</span> Update dependencies:
</span></span><span style=display:flex><span>$ go mod tidy           
</span></span><span style=display:flex><span>INFO<span style=color:#f92672>[</span>0000<span style=color:#f92672>]</span> Running make:
</span></span><span style=display:flex><span>$ make generate                
</span></span><span style=display:flex><span>mkdir -p /home/syyang/memcached-operator/bin
</span></span><span style=display:flex><span>Downloading sigs.k8s.io/controller-tools/cmd/controller-gen@v0.15.0
</span></span><span style=display:flex><span>go: downloading sigs.k8s.io/controller-tools v0.15.0
</span></span><span style=display:flex><span>go: downloading k8s.io/api v0.30.0
</span></span><span style=display:flex><span>go: downloading k8s.io/apiextensions-apiserver v0.30.0
</span></span><span style=display:flex><span>go: downloading k8s.io/apimachinery v0.30.0
</span></span><span style=display:flex><span>go: downloading golang.org/x/tools v0.20.0
</span></span><span style=display:flex><span>go: downloading golang.org/x/sys v0.19.0
</span></span><span style=display:flex><span>go: downloading golang.org/x/net v0.24.0
</span></span><span style=display:flex><span>/home/syyang/memcached-operator/bin/controller-gen object:headerFile<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;hack/boilerplate.go.txt&#34;</span> paths<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;./...&#34;</span>
</span></span><span style=display:flex><span>Next: implement your new API and generate the manifests <span style=color:#f92672>(</span>e.g. CRDs,CRs<span style=color:#f92672>)</span> with:
</span></span><span style=display:flex><span>$ make manifests
</span></span></code></pre></div><p>환경 확인</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~/memcached-operator $ ls
</span></span><span style=display:flex><span>api  cmd     Dockerfile  go.sum  internal  PROJECT    test
</span></span><span style=display:flex><span>bin  config  go.mod      hack    Makefile  README.md
</span></span></code></pre></div><p><code>api/v1alpha1/memcached_types.go</code> 를 통해 api 리소스가 만들어지고 <code>controllers/memcached_controller.go</code> 를 통해 컨트롤러가 만들어집니다. (정확히는 scaffold 합니다)</p><ul><li><p>참고</p><p>더 완벽한 튜토리얼을 위해서는 아래 명령을 시도해볼 수 있습니다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ operator-sdk create api --group cache --version v1alpha1 --kind Memcached --plugins<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;deploy-image/v1-alpha&#34;</span> --image<span style=color:#f92672>=</span>memcached:1.4.36-alpine --image-container-command<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;memcached,-m=64,modern,-v&#34;</span> --run-as-user<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;1001&#34;</span>
</span></span></code></pre></div><p>이번 예제는 single group API 경우에 대해서 다룹니다. multi-group 은 <a href=https://book.kubebuilder.io/migration/multi-group.html target=_blank rel=noopener>https://book.kubebuilder.io/migration/multi-group.html</a> 문서를 확인해야 합니다.</p></li></ul><p><a href=https://github.com/kubernetes-sigs/controller-runtime target=_blank rel=noopener>controller-runtime</a>에서 설정한 설계 목표를 제대로 따르기 위해, 프로젝트에서 생성된 각 API를 관리하는 전용 컨트롤러를 하나씩 두는 것이 권장됩니다.</p></li><li><p><strong>Define the API</strong></p><p>먼저, Memcached 타입을 정의하여 API를 표현할 것입니다. 이 타입은 MemcachedSpec.Size 필드를 통해 배포할 Memcached 인스턴스(CR)의 수를 설정하고, MemcachedStatus.Conditions 필드를 통해 CR의 상태(Conditions)를 저장할 것입니다.</p><p>api/v1alpha1/memcached_types.go 파일에서 Go 타입 정의를 수정하여 Memcached Custom Resource(CR)의 API에 다음과 같은 spec과 status를 추가하면 됩니다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// MemcachedSpec defines the desired state of Memcached</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>MemcachedSpec</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// INSERT ADDITIONAL SPEC FIELDS - desired state of cluster</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Important: Run &#34;make&#34; to regenerate code after modifying this file</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// The following markers will use OpenAPI v3 schema to validate the value</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// More info: https://book.kubebuilder.io/reference/markers/crd-validation.html</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// +kubebuilder:validation:Minimum=1</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// +kubebuilder:validation:Maximum=5</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// +kubebuilder:validation:ExclusiveMaximum=false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Size defines the number of Memcached instances</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// +operator-sdk:csv:customresourcedefinitions:type=spec</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Size</span> <span style=color:#66d9ef>int32</span> <span style=color:#e6db74>`json:&#34;size,omitempty&#34;`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Port defines the port that will be used to init the container with the image</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// +operator-sdk:csv:customresourcedefinitions:type=spec</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ContainerPort</span> <span style=color:#66d9ef>int32</span> <span style=color:#e6db74>`json:&#34;containerPort,omitempty&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// MemcachedStatus defines the observed state of Memcached</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>MemcachedStatus</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Represents the observations of a Memcached&#39;s current state.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Memcached.status.conditions.type are: &#34;Available&#34;, &#34;Progressing&#34;, and &#34;Degraded&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Memcached.status.conditions.status are one of True, False, Unknown.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Memcached.status.conditions.reason the value should be a CamelCase string and producers of specific</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// condition types may define expected values and meanings for this field, and whether the values</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// are considered a guaranteed API.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Memcached.status.conditions.Message is a human readable message indicating details about the transition.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// For further information see: https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#typical-status-properties</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Conditions store the status conditions of the Memcached instances</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// +operator-sdk:csv:customresourcedefinitions:type=status</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Conditions</span> []<span style=color:#a6e22e>metav1</span>.<span style=color:#a6e22e>Condition</span> <span style=color:#e6db74>`json:&#34;conditions,omitempty&#34; patchStrategy:&#34;merge&#34; patchMergeKey:&#34;type&#34; protobuf:&#34;bytes,1,rep,name=conditions&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>CRD 매니페스트에 status <a href=https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/#status-subresource target=_blank rel=noopener>서브리소스</a>를 추가하려면, +kubebuilder:subresource:status <a href=https://book.kubebuilder.io/reference/generating-crd.html#status target=_blank rel=noopener>마커</a>를 사용해야 합니다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Memcached is the Schema for the memcacheds API</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//+kubebuilder:subresource:status</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Memcached</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>metav1</span>.<span style=color:#a6e22e>TypeMeta</span>   <span style=color:#e6db74>`json:&#34;,inline&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>metav1</span>.<span style=color:#a6e22e>ObjectMeta</span> <span style=color:#e6db74>`json:&#34;metadata,omitempty&#34;`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Spec</span>   <span style=color:#a6e22e>MemcachedSpec</span>   <span style=color:#e6db74>`json:&#34;spec,omitempty&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Status</span> <span style=color:#a6e22e>MemcachedStatus</span> <span style=color:#e6db74>`json:&#34;status,omitempty&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Spec은 사용자가 원하는 상태(desired state)를 정의합니다. Status 는 현재의 실제 상태(actual state)를 나타냅니다. 추가한 마커를 통해, 서브리소스를 추가하고, 이를 통해 컨트롤러는 CR 객체의 나머지 부분을 변경하지 않고, status 필드만 업데이트할 수 있습니다.</p><p>참고로 <code>*_types.go</code> 파일을 수정한 후, 해당 리소스 타입의 생성된 코드를 업데이트하기 위해 항상 <code>make generate</code> 명령어를 수행해야 합니다. Makefile 타겟은 <a href=https://github.com/kubernetes-sigs/controller-tools target=_blank rel=noopener><code>controller-gen</code></a> 유틸리티를 호출하여 <code>api/v1alpha1/zz_generated.deepcopy.go</code> 파일을 업데이트합니다. 이를 통해 모든 Kind 타입이 구현해야 하는 <code>runtime.Object</code> 인터페이스를 우리의 API Go 타입 정의가 구현하도록 보장합니다.</p><p>위의 설명을 좀 더 풀어서 <code>zz_generated.deepcopy.go</code> 파일에 대해 설명하자면, Kubernetes는 컨트롤러, 캐시, 인덱서 등에서 객체를 복사하고 조작합니다. 이 과정에서 안전한 객체 복사(deepcopy)가 필수적입니다. DeepCopyObject() 함수는 <code>runtime.Object</code> 인터페이스를 구현합니다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Object</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>GetObjectKind</span>() <span style=color:#a6e22e>schema</span>.<span style=color:#a6e22e>ObjectKind</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DeepCopyObject</span>() <span style=color:#a6e22e>Object</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// DeepCopyObject is an autogenerated deepcopy function, copying the receiver, creating a new runtime.Object.</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>in</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Memcached</span>) <span style=color:#a6e22e>DeepCopyObject</span>() <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>Object</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>in</span>.<span style=color:#a6e22e>DeepCopy</span>(); <span style=color:#a6e22e>c</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>이후 <code>make manifests</code> 를 통해 CRD 매니페스트 파일을 생성할 수 있습니다. <code>config/crd/bases/cache.example.com_memcacheds.yaml</code> 경로에 생성됩니다.</p></li><li><p><strong>Implement the Controller</strong></p><p><code>internal/controllers/memcached_controller.go</code> 파일을 아래 내용으로 교체합니다.</p><ul><li><p>원 파일</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>Copyright 2024.
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);
</span></span></span><span style=display:flex><span><span style=color:#75715e>you may not use this file except in compliance with the License.
</span></span></span><span style=display:flex><span><span style=color:#75715e>You may obtain a copy of the License at
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>    http://www.apache.org/licenses/LICENSE-2.0
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>Unless required by applicable law or agreed to in writing, software
</span></span></span><span style=display:flex><span><span style=color:#75715e>distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
</span></span></span><span style=display:flex><span><span style=color:#75715e>WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
</span></span></span><span style=display:flex><span><span style=color:#75715e>See the License for the specific language governing permissions and
</span></span></span><span style=display:flex><span><span style=color:#75715e>limitations under the License.
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>controller</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;k8s.io/apimachinery/pkg/runtime&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ctrl</span> <span style=color:#e6db74>&#34;sigs.k8s.io/controller-runtime&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;sigs.k8s.io/controller-runtime/pkg/client&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;sigs.k8s.io/controller-runtime/pkg/log&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>cachev1alpha1</span> <span style=color:#e6db74>&#34;github.com/example/memcached-operator/api/v1alpha1&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// MemcachedReconciler reconciles a Memcached object</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>MemcachedReconciler</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Client</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Scheme</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>Scheme</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// +kubebuilder:rbac:groups=cache.example.com,resources=memcacheds,verbs=get;list;watch;create;update;patch;delete</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// +kubebuilder:rbac:groups=cache.example.com,resources=memcacheds/status,verbs=get;update;patch</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// +kubebuilder:rbac:groups=cache.example.com,resources=memcacheds/finalizers,verbs=update</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Reconcile is part of the main kubernetes reconciliation loop which aims to</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// move the current state of the cluster closer to the desired state.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// TODO(user): Modify the Reconcile function to compare the state specified by</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// the Memcached object against the actual cluster state, and then</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// perform operations to make the cluster state reflect the state specified by</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// the user.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// For more details, check Reconcile and its Result here:</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// - https://pkg.go.dev/sigs.k8s.io/controller-runtime@v0.18.4/pkg/reconcile</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>MemcachedReconciler</span>) <span style=color:#a6e22e>Reconcile</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>req</span> <span style=color:#a6e22e>ctrl</span>.<span style=color:#a6e22e>Request</span>) (<span style=color:#a6e22e>ctrl</span>.<span style=color:#a6e22e>Result</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>FromContext</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// TODO(user): your logic here</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ctrl</span>.<span style=color:#a6e22e>Result</span>{}, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// SetupWithManager sets up the controller with the Manager.</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>MemcachedReconciler</span>) <span style=color:#a6e22e>SetupWithManager</span>(<span style=color:#a6e22e>mgr</span> <span style=color:#a6e22e>ctrl</span>.<span style=color:#a6e22e>Manager</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ctrl</span>.<span style=color:#a6e22e>NewControllerManagedBy</span>(<span style=color:#a6e22e>mgr</span>).
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>For</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>cachev1alpha1</span>.<span style=color:#a6e22e>Memcached</span>{}).
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>Complete</span>(<span style=color:#a6e22e>r</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li></ul><p><a href=https://github.com/operator-framework/operator-sdk/blob/latest/testdata/go/v4/memcached-operator/internal/controller/memcached_controller.go target=_blank rel=noopener>https://github.com/operator-framework/operator-sdk/blob/latest/testdata/go/v4/memcached-operator/internal/controller/memcached_controller.go</a></p><p>이를 원래 파일과 비교하면 내용이 꽤나 많이 추가된 것을 볼 수 있는데, 아래의 내용은 컨트롤러가 어떻게 리소스를 감시하고 reconcile loop 이 작동하는 지 설명합니다.</p><p><strong>Setup a Recorder</strong></p><p>main.go 에 <code>Recorder: mgr.GetEventRecorderFor("memcached-controller"),</code> 를 추가합니다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = (<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>controller</span>.<span style=color:#a6e22e>MemcachedReconciler</span>{
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>Client</span>: <span style=color:#a6e22e>mgr</span>.<span style=color:#a6e22e>GetClient</span>(),
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>Scheme</span>: <span style=color:#a6e22e>mgr</span>.<span style=color:#a6e22e>GetScheme</span>(),
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>Recorder</span>: <span style=color:#a6e22e>mgr</span>.<span style=color:#a6e22e>GetEventRecorderFor</span>(<span style=color:#e6db74>&#34;memcached-controller&#34;</span>),
</span></span><span style=display:flex><span>        }).<span style=color:#a6e22e>SetupWithManager</span>(<span style=color:#a6e22e>mgr</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>setupLog</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;unable to create controller&#34;</span>, <span style=color:#e6db74>&#34;controller&#34;</span>, <span style=color:#e6db74>&#34;Memcached&#34;</span>)
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Exit</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        }
</span></span></code></pre></div><p>Reconciler의 개념은 다음과 같습니다. Reconciler는 Kubernetes에서 컨트롤러의 핵심 로직을 담당하는 구조체입니다. Kubernetes에서 컨트롤러는 목표 상태(desired state)와 현재 상태(actual state)를 비교하고, 이를 일치시키는 작업을 수행합니다. Reconciler는 이 과정에서 각 리소스(Custom Resource 포함)를 관찰하고, 필요한 업데이트나 변경 사항을 처리합니다. Event Recorder는 Kubernetes 리소스에서 발생하는 이벤트를 기록하는 역할을 합니다.</p><p><strong>Resources watched by the Controller</strong></p><p><code>controllers/memcached_controller.go</code> 파일의 <code>SetupWithManager()</code> 함수는 컨트롤러가 어떻게 구축되어, 해당 CR 및 컨트롤러가 소유하고 관리하는 다른 리소스들을 감시할지를 정의합니다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>appsv1</span> <span style=color:#e6db74>&#34;k8s.io/api/apps/v1&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>MemcachedReconciler</span>) <span style=color:#a6e22e>SetupWithManager</span>(<span style=color:#a6e22e>mgr</span> <span style=color:#a6e22e>ctrl</span>.<span style=color:#a6e22e>Manager</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ctrl</span>.<span style=color:#a6e22e>NewControllerManagedBy</span>(<span style=color:#a6e22e>mgr</span>).
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>For</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>cachev1alpha1</span>.<span style=color:#a6e22e>Memcached</span>{}).
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Owns</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>appsv1</span>.<span style=color:#a6e22e>Deployment</span>{}).
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Complete</span>(<span style=color:#a6e22e>r</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>NewControllerManagedBy()</code> 함수는 다양한 컨트롤러 구성을 가능하게 하는 컨트롤러 빌더를 제공합니다.</p><p><code>For(&amp;cachev1alpha1.Memcached{})</code>는 Memcached 타입을 주요 감시 대상 리소스로 지정합니다. 각 Memcached 객체에 대해 Add/Update/Delete 이벤트가 발생할 때마다, 해당 Memcached 객체에 대한 reconcile 요청(네임스페이스/이름 키)이 Reconcile 루프로 전송됩니다.</p><p><code>Owns(&amp;appsv1.Deployment{})</code>는 Deployment 타입을 보조 감시 대상 리소스로 지정합니다. 각 Deployment 객체에 대해 Add/Update/Delete 이벤트가 발생하면, 이벤트 핸들러는 이를 해당 Deployment의 소유자에 대한 reconcile 요청으로 매핑합니다. 이 경우, Deployment의 소유자는 해당 Memcached 객체입니다.</p><p>이 경우, 의존 객체(Deployment)는 <code>Owner References</code> 필드에 자신의 소유 객체를 참조해야 합니다. 이 필드는 <code>ctrl.SetControllerReference</code> 메서드를 사용하여 추가할 수 있습니다.</p><p>참고: k8s API는 <code>ownerRef</code> 필드에 따라 리소스를 관리합니다. 이 메서드를 사용하면 <code>ownerRef</code>가 올바르게 설정됩니다. 따라서, K8s API는 Memcached Kind의 Custom Resource에 의존하는 리소스(예: Memcached Operand 이미지를 실행하는 Deployment)를 인식하게 됩니다. 이렇게 하면 Custom Resource가 삭제될 때, 모든 의존 리소스도 함께 삭제될 수 있습니다.</p><p><strong>Controller Configurations</strong></p><p>이외에 컨트롤러를 시작하기 위한 여러 유용한 설정들이 존재합니다. 아래 내용 말고도 <a href=https://pkg.go.dev/sigs.k8s.io/controller-runtime/pkg/builder#example-Builder target=_blank rel=noopener>builder</a> 와 <a href=https://pkg.go.dev/sigs.k8s.io/controller-runtime/pkg/controller target=_blank rel=noopener>controller</a> godoc를 통해 다른 설정들을 더 자세하게 살펴볼 수 있습니다.</p><ul><li><p>concurrent Reconciles 의 최대 수를 지정하는 옵션은 아래와 같습니다. (기본 값은 1 입니다)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>MemcachedReconciler</span>) <span style=color:#a6e22e>SetupWithManager</span>(<span style=color:#a6e22e>mgr</span> <span style=color:#a6e22e>ctrl</span>.<span style=color:#a6e22e>Manager</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ctrl</span>.<span style=color:#a6e22e>NewControllerManagedBy</span>(<span style=color:#a6e22e>mgr</span>).
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>For</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>cachev1alpha1</span>.<span style=color:#a6e22e>Memcached</span>{}).
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Owns</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>appsv1</span>.<span style=color:#a6e22e>Deployment</span>{}).
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>WithOptions</span>(<span style=color:#a6e22e>controller</span>.<span style=color:#a6e22e>Options</span>{<span style=color:#a6e22e>MaxConcurrentReconciles</span>: <span style=color:#ae81ff>2</span>}).
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Complete</span>(<span style=color:#a6e22e>r</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li><p><a href=https://sdk.operatorframework.io/docs/building-operators/golang/references/event-filtering/ target=_blank rel=noopener>predicates</a> 를 통해 watch events를 필터링 할 수 있습니다.</p></li><li><p>감시 이벤트가 Reconcile 루프로의 요청으로 어떻게 변환될지를 결정하려면 적절한 EventHandler 타입을 선택해야 합니다. 기본(primary) 리소스와 보조(secondary) 리소스 관계보다 더 복잡한 Operator 관계에서는, <code>EnqueueRequestsFromMapFunc</code> 핸들러를 사용하여 감시 이벤트를 임의의 Reconcile 요청 세트로 변환할 수 있습니다.</p></li></ul><p><strong>Reconcile loop <a href=https://sdk.operatorframework.io/docs/building-operators/golang/tutorial/#reconcile-loop target=_blank rel=noopener></a></strong></p><p>Reconcile 함수는 감시 중인 CR 또는 리소스에서 이벤트가 발생할 때마다 이 함수가 실행되며, 목표 상태와 현재 상태가 일치하는지 여부에 따라 반환값이 달라집니다.</p><p>이와 같이, 모든 컨트롤러는 Reconcile() 메서드를 구현하는 Reconciler 객체를 가지고 있으며, 이 메서드는 Reconcile 루프를 구현합니다. Reconcile 루프는 Request 인자를 전달받는데, 이 인자는 네임스페이스/이름 키로, 캐시에서 주요 리소스 객체인 Memcached를 조회하는 데 사용됩니다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ctrl</span> <span style=color:#e6db74>&#34;sigs.k8s.io/controller-runtime&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cachev1alpha1</span> <span style=color:#e6db74>&#34;github.com/example/memcached-operator/api/v1alpha1&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>MemcachedReconciler</span>) <span style=color:#a6e22e>Reconcile</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>req</span> <span style=color:#a6e22e>ctrl</span>.<span style=color:#a6e22e>Request</span>) (<span style=color:#a6e22e>ctrl</span>.<span style=color:#a6e22e>Result</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Lookup the Memcached instance for this reconcile request</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>memcached</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>cachev1alpha1</span>.<span style=color:#a6e22e>Memcached</span>{}
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>NamespacedName</span>, <span style=color:#a6e22e>memcached</span>)
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Reconciler, Client, 그리고 리소스 이벤트와 상호작용하는 방법에 대한 자세한 안내는 <a href=https://sdk.operatorframework.io/docs/building-operators/golang/references/client/ target=_blank rel=noopener>Client API 문서</a>를 참고 하시면 됩니다.</p><p>Reconciler에서 사용할 수 있는 반환 옵션 몇 가지는 다음과 같습니다. 더 자세한 것 내용은 <a href=https://pkg.go.dev/sigs.k8s.io/controller-runtime/pkg/reconcile target=_blank rel=noopener>Reconcile godoc</a>을 참고하셔야 합니다.</p><ol><li><p>오류가 있는 경우:</p><p><code>return ctrl.Result{}, err</code></p><p>오류가 발생하면, ctrl.Result{}와 함께 오류를 반환합니다. 이 경우, Reconcile 함수는 오류를 처리하고 재시도할 수 있습니다.</p></li><li><p>오류 없이 재시도 요청:</p><p><code>return ctrl.Result{Requeue: true}, nil</code></p><p>오류는 없지만, Reconcile 루프를 다시 실행하고 싶을 때 사용합니다. Requeue: true 옵션은 즉시 재시도를 요청합니다.</p></li><li><p>Reconcile 중지:</p><p><code>return ctrl.Result{}, nil</code></p><p>리소스의 현재 상태가 목표 상태와 일치할 때 사용합니다. Reconcile 루프를 멈추고, 추가적인 재시도는 요청하지 않습니다.</p></li><li><p>X 시간 후에 다시 Reconcile:</p><p><code>return ctrl.Result{RequeueAfter: 5 * time.Minute}, nil</code></p><p>일정 시간이 지난 후에 Reconcile을 다시 실행하고 싶을 때 사용합니다. 위의 예시에서는 5분 후에 재시도합니다.</p></li></ol><p><strong>Specify permissions and generate RBAC manifests</strong></p><p>컨트롤러가 관리하는 리소스와 상호작용하기 위해서는 특정 ****RBAC 권한이 필요합니다. 이러한 권한은 다음과 같은 RBAC 마커(RBAC markers)를 통해 지정할 수 있습니다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>//+kubebuilder:rbac:groups=cache.example.com,resources=memcacheds,verbs=get;list;watch;create;update;patch;delete</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//+kubebuilder:rbac:groups=cache.example.com,resources=memcacheds/status,verbs=get;update;patch</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//+kubebuilder:rbac:groups=cache.example.com,resources=memcacheds/finalizers,verbs=update</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//+kubebuilder:rbac:groups=core,resources=events,verbs=create;patch</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//+kubebuilder:rbac:groups=apps,resources=deployments,verbs=get;list;watch;create;update;patch;delete</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//+kubebuilder:rbac:groups=core,resources=pods,verbs=get;list;watch</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>MemcachedReconciler</span>) <span style=color:#a6e22e>Reconcile</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>req</span> <span style=color:#a6e22e>ctrl</span>.<span style=color:#a6e22e>Request</span>) (<span style=color:#a6e22e>ctrl</span>.<span style=color:#a6e22e>Result</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>make manifests</code> 명령을 통해 <code>ClusterRole</code> 매니페스트를 <code>config/rbac/role.yaml</code> 경로에 생성합니다.</p><p>이후 문서 내용은 배포 과정을 설명하고 있습니다.</p></li></ul></div><div class="row ps-3 pe-3"><div class="col-md-6 share-buttons"></div><div class="col-md-6 btn-improve-page"><a href=https://github.com/Larshavin/Larshavin.github.io/edit/main/content/posts/500.%20Tech_Dev/%ec%bf%a0%eb%b2%84%eb%84%a4%ed%8b%b0%ec%8a%a4%20%eb%84%a4%ec%9d%b4%ed%8b%b0%eb%b8%8c%20%ea%b0%9c%eb%b0%9c/Operator%20Framework.md title="Improve this page" target=_blank rel=noopener><i class="fas fa-code-branch"></i>
Improve this page</a></div></div><hr><div class="row next-prev-navigator"><div class="col-md-6 previous-article"><a href=/posts/400.-project/ title="400. Project" class="btn filled-button"><div><i class="fas fa-chevron-circle-left"></i> Prev</div><div class=next-prev-text>400. Project</div></a></div><div class="col-md-6 next-article"><a href=/posts/500.-tech_dev/%EC%BF%A0%EB%B2%84%EB%84%A4%ED%8B%B0%EC%8A%A4-%EA%B8%B0%EB%B3%B8/%EC%BF%A0%EB%B2%84%EB%84%A4%ED%8B%B0%EC%8A%A4%EA%B0%80-%EB%AD%90%EC%A7%80/ title="쿠버네티스가 뭐지 1" class="btn filled-button"><div>Next <i class="fas fa-chevron-circle-right"></i></div><div class=next-prev-text>쿠버네티스가 뭐지 1</div></a></div></div><hr></div></div></div><a id=scroll-to-top class=btn type=button data-bs-toggle=tooltip data-bs-placement=left title="Scroll to top"><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center ps-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents><ul><li><a href=#개요->개요 :</a><ul><li><a href=#kubebuilder-구조>kubebuilder 구조</a><ul><li><a href=#1-client><strong>1. Client</strong></a></li><li><a href=#2-cache><strong>2. Cache</strong></a></li><li><a href=#3-controller><strong>3. Controller</strong></a></li><li><a href=#4-predicate><strong>4. Predicate</strong></a></li><li><a href=#5-reconciler><strong>5. Reconciler</strong></a></li><li><a href=#6-webhook><strong>6. Webhook</strong></a></li></ul></li></ul></li><li><a href=#문서-따라하기>문서 따라하기</a><ul><li><ul><li><a href=#overview>overview</a></li><li><a href=#설치>설치</a></li><li><a href=#프로젝트-생성>프로젝트 생성</a><ul><li><a href=#manager><strong>Manager</strong></a></li></ul></li></ul></li></ul></li></ul></nav></div></div></section></div><footer id=footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-start"><div class="col-md-4 col-sm-12"><h5>Navigation</h5><ul><li class=nav-item><a class=smooth-scroll href=https://kubesy.com/#about>About</a></li><li class=nav-item><a class=smooth-scroll href=https://kubesy.com/#skills>Skills</a></li><li class=nav-item><a class=smooth-scroll href=https://kubesy.com/#education>Education</a></li><li class=nav-item><a class=smooth-scroll href=https://kubesy.com/#experiences>Experiences</a></li><li class=nav-item><a class=smooth-scroll href=https://kubesy.com/#recent-posts>Recent Posts</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><ul><li><a href=mailto:gkdlgkdl2040@gmail.com target=_blank rel=noopener><span><i class="fas fa-envelope"></i></span> <span>gkdlgkdl2040@gmail.com</span></a></li><li><a href=tel:+82%20010-4207-5229 target=_blank rel=noopener><span><i class="fas fa-phone-alt"></i></span> <span>+82 010-4207-5229</span></a></li></ul></div><div class="col-md-4 col-sm-12"><p>Stay up to date with email notification</p><form method=post action=https://blogtrottr.com><div class=form-group><input type=email class=form-control name=btr_email placeholder="Enter email"><br><input type=hidden name=btr_url value=https://kubesy.com//index.xml>
<input type=hidden name=schedule_type value=1>
<small id=emailHelp class="form-text text-muted">By entering your email address, you agree to receive the newsletter of this website.</small>
<button type=submit class="btn btn-info"> Submit</button></div></form></div></div></div><hr><div class=container><div class="row text-start"><div class=col-md-4><a id=theme href=https://github.com/hugo-toha/toha target=_blank rel=noopener><img src=/images/theme-logo_hu_b3360284c55cf72d.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">© 2025 Copyright.</div><div class="col-md-4 text-end"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script src=/application.535eb0f1aa800085b38be4369dadb763d2d3b2c81513f53e0664819331cc8bca.js integrity="sha256-U16w8aqAAIWzi+Q2na23Y9LTssgVE/U+BmSBkzHMi8o=" defer></script></body></html>